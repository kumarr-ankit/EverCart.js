<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UPI QR Payment</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        body {
            background: #121212;
            font-family: Arial, sans-serif;
            color: #fff;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 420px;
            margin: 40px auto;
            background: #1E1E1E;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #2c2c2c;
        }

        .title {
            font-size: 22px;
            margin-bottom: 18px;
            text-align: center;
            font-weight: bold;
        }

        /* ⭐ Round QR Card */
        .qr-card {
            background: #000;
            padding: 16px;
            border-radius: 20px;
            display: inline-block;
            box-shadow: 0px 0px 10px rgba(255, 255, 255, 0.07);
        }

        .qr-box {
            display: flex;
            justify-content: center;
            padding: 20px 0;
        }

        #qrCode canvas {
            border-radius: 14px;
            /* Slight rounding of actual QR */
        }

        .details {
            margin: 15px 0;
            background: #232323;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #333;
        }

        .row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 15px;
        }

        .pay-now {
            margin-top: 15px;
            background: #2874f0;
            border: none;
            padding: 14px;
            width: 100%;
            color: white;
            border-radius: 10px;
            font-size: 17px;
            cursor: pointer;
        }

        .pay-now:hover {
            background: #1a5fc9;
        }

        .hint {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            opacity: 0.8;
        }
    </style>

</head>

<body>

    <div class="container">

        <div class="title">Scan & Pay</div>

        <div class="details">
            <div class="row"><span>Pay To:</span> <span id="nameBox">-</span></div>
            <div class="row"><span>UPI ID:</span> <span id="upiBox">-</span></div>
            <div class="row"><span>Amount:</span> <span id="amountBox">-</span></div>
        </div>

        <div class="qr-box">
            <div class="qr-card">
                <div id="qrCode"></div>
            </div>
        </div>

        <button class="pay-now" id="payNowBtn">Pay Using UPI App</button>

        <div class="hint">Scan with PhonePe / GPay / Paytm or Tap the button</div>

    </div>

<script>
    const urlParams = new URLSearchParams(window.location.search);

    let method = urlParams.get('method');
    console.log(method);

    if (method === 'cash') {
        location.href = `./order-success.html?method=${method}`;
    }

    else if (method === "upi") {
        console.log("upi method working");

        const upi = urlParams.get("payment") || "ankit@oksbi";
        const name = urlParams.get("seller") || "EverCart";
        const amount = urlParams.get("amount") || "1";

        document.getElementById("upiBox").innerText = upi;
        document.getElementById("nameBox").innerText = name;
        document.getElementById("amountBox").innerText = "₹" + amount;

        // Normal UPI URL
        const upiURL =
            `upi://pay?pa=${upi}&pn=${encodeURIComponent(name)}&am=${amount}&cu=INR`;

        // Chrome/Android "intent://" fallback
        const intentURL =
            `intent://pay?pa=${upi}&pn=${encodeURIComponent(name)}&am=${amount}&cu=INR#Intent;scheme=upi;package=com.phonepe.app;end`;

        console.log("UPI URL:", upiURL);

        // Generate QR
        new QRCode(document.getElementById("qrCode"), {
            text: upiURL,
            width: 220,
            height: 220
        });

        // ============================
        // FUNCTION TO LAUNCH UPI APPS
        // ============================
        function tryOpenUPI() {
            console.log("Trying upi://");

            // Try direct scheme
            window.location.href = upiURL;

            // In case browser blocks it → fallback
            setTimeout(() => {
                console.log("Trying intent:// fallback");
                window.location.href = intentURL;
            }, 800);
        }

        // Hidden link fallback
        function forceClickFallback() {
            try {
                const a = document.createElement("a");
                a.href = upiURL;
                a.style.display = "none";
                document.body.appendChild(a);
                a.click();
                a.remove();
            } catch (err) {
                alert("Can not open upi apps.")
                console.log("Hidden link failed:", err);
            }
        }

        document.getElementById("payNowBtn").addEventListener("click", () => {
            tryOpenUPI();
            setTimeout(forceClickFallback, 1200); // last fallback
        });

        // Clicking QR also tries to open app
        document.getElementById("qrCode").addEventListener("click", () => {
            tryOpenUPI();
            setTimeout(forceClickFallback, 1200);
        });
    }
</script>

</body>

</html>